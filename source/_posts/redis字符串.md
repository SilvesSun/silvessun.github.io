---
title: redis字符串
date: 2018-12-18 09:29:41
tags:
- 基本数据结构
- 字符串
categories:
- redis
---

## 简单动态字符串
Redis 自己构建一种名为`简单动态字符串`(SDS)的抽象类型, 这是 Redis 的默认字符串表示. 传统的 C 字符串只用在无需对字符串进行修改的地方. 其他可能修改
的地方都使用 SDS 字符串

除了用来保存数据库中的字符串值以外, SDS 还被用作缓冲区: AOF 缓冲区和 客户端状态中的输入缓冲区都是由 SDS 实现的

### 结构定义
一个 sdshdr 表示一个 SDS 值

```C
struct sdshdr

{
int len; //记录buf数组中已使用的字节数量
int free; // 未使用字节的数量
char buf[]; //字节数组, 用于保存字符串    
};
```

![](http://supcoder.net/sds.png)

### SDS 和 C 字符串的区别
#### 常数复杂度获取字符串长度
C 语言使用长度为 N+ 1 的字符数组来表示长度为 N 的字符串， 并且字符数组的最后一个元素总是空字符'\0'。

这里, C字符串因为没有记录字符串的长度, 所以当需要获取字符串长度的时候需要遍历数组知道找到一个代表字符串结束的字符为止. 这里SDS获取字符串长度的复杂度为 O(1)

#### 杜绝缓冲区溢出
SDS 的空间分配策略: 当需要对SDS 进行修改时, 首先检查 SDS 空间是否满足修改所需的要求, 不满足的情况下会自动扩展空间至执行修改时所需的大小, 避免了溢出

#### 减少修改字符串带来的内存重分配次数
通过未使用空间, SDS 实现了空间预分配和惰性空间释放两种优化策略

1. 空间预分配策略用于优化 SDS 字符串增长操作
   当对一个 SDS 进行修改且需要进行空间扩展的时候, 程序会为SDS 分配额外的空间

   如果修改后的长度小于 1MB, 那么程序分配和 len 一样大小的未使用空间; 如果大于1MB, 分配1MB的未使用空间

2. 惰性空间释放
   当需要缩短 SDS 保存的字符串时, 程序不会立即回收多出来的字节, 而是使用free 记录, 等待将来再用. 当真正需要释放内存时, 也有相应的 API 可操作

### 二进制安全
所有SDS API 都会以处理二进制的方式来处理SDS存放在buf数组里的数据. 通过使用二进制安全的 SDS, 使得Redis不仅可以保存文本数据, 还可以保存任意格式的数据



# 命令
`set key value [ex seconds] [px milliseconds] [nx|xx] `

- ex seconds 为键设置秒级过期时间
- px milliseconds 为键设置毫秒级过期时间
- nx|xx nx键必须不存在时才能添加, 用于增加; xx键必须存在才能设置, 用于更新


