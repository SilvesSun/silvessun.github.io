---
title: InnoDB存储引擎数据结构
date: 2019-03-20 11:06:23
tags:
- InnoDB
- 数据结构
categories:
- 数据库
---

# B树和B+树的区别
![](http://supcoder.net/B-Tree.png)

- B+树中只有叶子节点会带有指向记录的指针（ROWID），而B树则所有节点都带有，在内部节点出现的索引项不会再出现在叶子节点中。

- B+树中所有叶子节点都是通过指针连接在一起，而B树不会

# InnoDB 和 Myisam 的区别
## 存储结构的不同
- MyISAM 每个MyISAM在磁盘上存储为三个文件, 表定义文件/数据文件/索引文件. 第一个文件的名字以表名开头, 扩展名指出文件类型. `.frm`文件存储表定义,
`.MYD` 文件存储表数据, `.MYI`文件存储索引

- InnoDB 基于磁盘的资源是InnoDB表空间数据文件和它的日志文件. 大小受限于操作系统的大小, 一般为2G

## 事务
InnoDB 提供事务/外键等支持, MyISAM不支持事务

## select/update/insert/delete
如果主要表主要是提供查询, 比如报表系统, MyISAM更好; 如果对数据有大量的更新插入, 选择InnoDB

## 锁
MyISAM 只支持表级锁, InnoDB支持事务和行级锁. 注意InnoDB的行级锁只在`where`主键有效的时候有用. 非主键的where都会锁表

## select count(*) from table
MyISAM只要简单的读出保存好的行数，注意的是，当count(*)语句包含 where条件时，两种表的操作是一样的

InnoDB 中不 保存表的具体行数，也就是说，执行select count(*) from table时，InnoDB要扫描一遍整个表来计算有多少行

## 自增
- MyISAM  可以和其他字段一起建立联合索引。引擎的自动增长列必须是索引，如果是组合索引，自动增长可以不是第一列，可以根据前面几列进行排序后递增
- InnoDB  InnoDB中必须包含只有该字段的索引。引擎的自动增长列必须是索引，如果是组合索引也必须是组合索引的第一列

# InnoDB的关键特性
## 插入缓冲(insert buffer)

insert buffer 是一颗 B+树. 放在共享表空间中

对于非聚集索引的插入或者更新操作, 不是一次直接插入到索引页中, 而是先判断插入的非聚集索引是否在缓冲池中, 若在则直接插入; 若不在, 则先放入到一个 
Insert Buffer 中, 然后再以一定的频率和情况进行 Insert Buffer 和辅助索引叶子节点的合并操作, 这时通常能一次插入多个记录, 从而提高了效率.

Insert Buffer的使用需要满足的条件为:
- 索引是辅助索引
- 索引不是唯一的

change buffer 可以视为 Insert Buffer 的升级

insert buffer 的合并操作可能发生的情况:
- 辅助索引页被读取到缓冲池中
- Insert Buffer Bitmap页追踪到该辅助索引页已无可用空间
- Master Thread

## 两次写
数据页的可靠性.

当发生写失效时, 先通过页的副本来还原该页, 再应用重做日志. 

## 自适应哈希索引
InnoDB 会监控对表上各索引页的查询, 如果观察到建立哈希索引可以带来速度提升, 则建立哈希索引. 称为自适应哈希索引

## 异步IO
## 刷新邻接页
当刷新一个脏页时, InnoDB会检测该页所在区的所有页, 如果是脏页, 那么一起刷新.

## 预读
I/O的优化上有个比较重要的特性为预读，预读请求是一个i/o请求，它会异步地在缓冲池中预先回迁多个页面，预计很快就会需要这些页面，这些请求在一个范围内引入所有页面

# InnoDB事务的实现方式
事务的隔离性由锁实现, 原子性/一致性/持久性 由数据库的 `redo log` 和 `undo log`完成. 重做日志保证事务的原子性和持久性, undo log用来保证事事务的一致性

redo 通常是物理日志, 记录页的物理操作; undo是逻辑日志, 根据每行记录进行记录

## 重做日志
包括两部分, 内存中的重做日志缓冲 和 重做日志文件

通过 `Force Log at Commit` 机制实现事务的持久性. 即当事务提交时, 必须先将事务的所有日志写入到重做日志文件进行持久化, 待事务的commit操作完成才算完成






